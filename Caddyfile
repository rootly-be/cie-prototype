# =============================================================================
# Caddy Configuration
# Story 8.3: Configure Caddy for SSL and Reverse Proxy
#
# Features:
# - Automatic Let's Encrypt SSL (AC1, NFR8)
# - Reverse proxy to Next.js app (AC2)
# - HTTP to HTTPS redirect (AC3)
# - Security headers (AC4)
# =============================================================================

# Replace with your actual domain
{$DOMAIN:localhost} {
    # Reverse proxy to Next.js app
    reverse_proxy app:3000 {
        # Health check
        health_uri /api/health
        health_interval 30s
        health_timeout 10s
    }

    # Security headers (AC4)
    header {
        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"

        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"

        # XSS protection
        X-XSS-Protection "1; mode=block"

        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"

        # Content Security Policy
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://www.billetweb.fr;"

        # Permissions policy
        Permissions-Policy "geolocation=(), microphone=(), camera=()"

        # Remove server header
        -Server
    }

    # Gzip compression
    encode gzip

    # Logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 10mb
            roll_keep 5
        }
    }
}
